<!DOCTYPE html>
<html>
<head>
    <title>NEONVERSE 3D | OPEN WORLD</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; }
        #ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; color: #fff; padding: 20px; }
        .stats { background: rgba(0,242,255,0.1); border-left: 4px solid #00f2ff; padding: 15px; width: 200px; }
        #crosshair { position: fixed; top: 50%; left: 50%; width: 10px; height: 10px; border: 2px solid #ff00ff; border-radius: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats">
        <div>LVL: <span id="lvl">1</span></div>
        <div id="quest" style="font-size: 10px; color: #ff00ff; margin-top: 5px;">QUEST: TRAVEL TO NEXT ISLAND</div>
    </div>
</div>
<div id="crosshair"></div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

// --- FIREBASE SETUP ---
const firebaseConfig = {
    apiKey: "AIzaSyD9I2tePOBy4OdbFjbAzxAPvvziqvoe0QI",
    authDomain: "neonverse-aars.firebaseapp.com",
    projectId: "neonverse-aars",
    storageBucket: "neonverse-aars.firebasestorage.app",
    databaseURL: "https://neonverse-aars-default-rtdb.firebaseio.com",
    messagingSenderId: "612438599755",
    appId: "1:612438599755:web:43f1c0a553d56c3aa045ce"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const myId = "p_" + Math.floor(Math.random()*999);

// --- 3D ENGINE SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020205);
scene.fog = new THREE.FogExp2(0x020205, 0.002);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// --- LIGHTING ---
const light = new THREE.PointLight(0x00f2ff, 1000, 500);
scene.add(light);
scene.add(new THREE.AmbientLight(0x404040));

// --- ISLANDS ---
function createIsland(x, z, color) {
    const geo = new THREE.BoxGeometry(100, 10, 100);
    const mat = new THREE.MeshPhongMaterial({ color: color, emissive: color, emissiveIntensity: 0.2 });
    const island = new THREE.Mesh(geo, mat);
    island.position.set(x, -5, z);
    scene.add(island);
    
    // Grid Helper for "Pro" look
    const grid = new THREE.GridHelper(100, 10, color, 0x444444);
    grid.position.set(x, 0.1, z);
    scene.add(grid);
}
createIsland(0, 0, 0x00f2ff);    // Starter Island
createIsland(500, 500, 0xff00ff); // Battle Island

// --- PLAYER ---
const playerGroup = new THREE.Group();
const bodyGeo = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
const bodyMat = new THREE.MeshStandardMaterial({ color: 0x00f2ff });
const body = new THREE.Mesh(bodyGeo, bodyMat);
playerGroup.add(body);
scene.add(playerGroup);

// --- INPUTS ---
const keys = {};
window.addEventListener('keydown', (e) => keys[e.code] = true);
window.addEventListener('keyup', (e) => keys[e.code] = false);

let otherPlayers = {};
onValue(ref(db, 'players'), (snap) => {
    const data = snap.val();
    for (let id in data) {
        if (id === myId) continue;
        if (!otherPlayers[id]) {
            const m = new THREE.Mesh(bodyGeo, new THREE.MeshStandardMaterial({ color: 0xff00ff }));
            scene.add(m);
            otherPlayers[id] = m;
        }
        otherPlayers[id].position.set(data[id].x, data[id].y, data[id].z);
    }
});

onDisconnect(ref(db, 'players/' + myId)).remove();

// --- GAME LOOP ---
function animate() {
    requestAnimationFrame(animate);

    // Movement Physics
    const speed = 0.5;
    if (keys['KeyW']) playerGroup.translateZ(-speed);
    if (keys['KeyS']) playerGroup.translateZ(speed);
    if (keys['KeyA']) playerGroup.translateX(-speed);
    if (keys['KeyD']) playerGroup.translateX(speed);
    if (keys['Space']) playerGroup.position.y += 0.2;
    playerGroup.position.y -= 0.1; // Gravity
    if (playerGroup.position.y < 0) playerGroup.position.y = 0;

    // Camera Follow
    camera.position.set(playerGroup.position.x, playerGroup.position.y + 5, playerGroup.position.z + 10);
    camera.lookAt(playerGroup.position);
    light.position.copy(playerGroup.position);

    // Sync to Firebase
    set(ref(db, 'players/' + myId), {
        x: playerGroup.position.x,
        y: playerGroup.position.y,
        z: playerGroup.position.z
    });

    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
